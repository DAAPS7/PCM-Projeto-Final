---
title: "MusicaInator 3000"
format:
  dashboard: 
    orientation: columns
    scrolling: false
    page-layout: none
    css: assets/css/style.css
    code-copy: false
    fill: true
    logo: "assets/img/logo.png"
    include-in-header:
      text: |
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
        <link rel="icon" href="assets/img/logo.png">
---

## Column

### Row 1 {height=80vh}

```{ojs}
//| include: false
//| echo: false

// Audio Context object
audioContext = new AudioContext();
audioEl = document.createElement("audio")
audioEl.controls = true
document.body.appendChild(audioEl)
audioEl.hidden = true

```

```{ojs}
//| include: false
//| echo: false

async function audioPlayback(audioFile) {
    let sourceNode;
    let analyser;

    if (audioContext.state === "suspended") {
        await audioContext.resume();
    }

    // Create nodes once
    if (!sourceNode) {
        analyser = audioContext.createAnalyser();
        sourceNode = audioContext.createMediaElementSource(audioEl);
        sourceNode.connect(analyser);
        analyser.connect(audioContext.destination);
    }

    audioEl.src = URL.createObjectURL(audioFile);
    audioEl.load();
}

async function audioRecognitionAPI(audioFile) {
    const token = "c68dc7c96dc75ce14c48740ab7bf4b08";

    const formData = new FormData();
    formData.append("api_token", token);
    formData.append("file", audioFile);
    formData.append("return", "apple_music,spotify");
    formData.append("accurate_offsets", "true");
    formData.append("skip", "3");
    formData.append("every", "1");

    const response = await fetch("https://api.audd.io/", {
        method: "POST",
        body: formData
    });

    const data = await response.json();
    console.log(data);
    return data;
}

```

```{ojs}
//| include: false
//| echo: false

songPopularity = resultAPI ? `Popularity: ${resultAPI?.result?.spotify?.popularity}` : "Popularity"

```

```{ojs}
//| include: false
//| echo: false

trackName = resultAPI ? resultAPI.result.title : "Waiting for track..."

```

```{ojs}
//| include: false
//| echo: false

artistName = resultAPI ? resultAPI.result.artist : "Waiting for artist..."

```

```{ojs}
//| include: false
//| echo: false

mutable audioTime = 0;

audioEl.addEventListener("timeupdate", () => {
    mutable audioTime = audioEl.currentTime;
});
songDuration = resultAPI ? audioEl.duration : "0:00"

```

```{ojs}
//| include: false
//| echo: false

imageURL = resultAPI?.result?.spotify?.album?.images[0]?.url ?? "https://placehold.co/400?text=No+Art"

```

```{ojs}
//| include: false
//| echo: false

spotifyTimeCode = resultAPI?.result?.timecode ?? "Duration"

```

```{ojs}
//| include: false
//| echo: false

albumName = resultAPI?.result?.album ?? "Album"

```

```{ojs}
//| include: false
//| echo: false

releaseDate = resultAPI?.result?.release_date ?? "Release Date"

```

```{ojs}
//| expandable: false
//| classes: song-card

viewof audioFile = {
  const root = html`
    <label class="uploadButton">
      <input id="upload-input" type="file" accept="audio/*" hidden />
      <span>Upload audio</span>
    </label>
  `;

  const input = root.querySelector("input");

  root.value = null;

  input.addEventListener("change", () => {
    root.value = input.files;  
    root.dispatchEvent(new Event("input"));
  });

  return root;
}

resultAPI = {
    if (!audioFile || audioFile.length === 0) return null;

    console.log("called");

    const file = audioFile[0];     
    audioPlayback(file);

    const res = await audioRecognitionAPI(file);
    return res;
}

songCard = html `
  <div class="song-card-div">
    <img id="cover" src="https://placehold.co/400?text=No+Art">

    <div style="align-items: center">
      <h1 class="song-title">Waiting for track...</h1>

      <div class="song-properties">
        <span class="song-card-artist" style="font-weight: bolder; color: white">Artist</span>
        <span>•</span>
        <span id="album" style="color: white">Album</span>
        <span>•</span>
        <span id="release-date">Release Date</span>
        <span>•</span>
        <span id="timecode">Duration</span>
        <span>•</span>
        <span id="popularity">Popularity</span>
      </div>
    </div>
  </div>
`;

propertiesUpdate = {
    // Don't update if audio isn't fully loaded
    if (!resultAPI) return;

    songCard.querySelector(".song-title").textContent = trackName;
    songCard.querySelector(".song-card-artist").textContent = artistName;
    songCard.querySelector("#album").textContent = albumName;
    songCard.querySelector("#release-date").textContent = releaseDate;
    songCard.querySelector("#cover").src = imageURL;
    songCard.querySelector("#timecode").textContent = spotifyTimeCode;
    songCard.querySelector("#popularity").textContent = songPopularity;

    return 0;
}

```

```{ojs}
//| expandable: false

// Lyric API call
lyrics = {
    // Don't fetch if we don't have real data yet
    if (!resultAPI || !resultAPI.result) {
        return null;
    }

    let query = {
        track_name: trackName,
        artist_name: artistName
    }

    const params = new URLSearchParams(query);
    const response = await fetch(`https://lrclib.net/api/get?${params}`);
    const data = await response.json();

    return data
}

lyrics?.syncedLyrics ?? "No lyrics available yet."

```

### Row 2 {height=15vh}

```{ojs}
//| expandable: false
//| classes: play-bar-card

function formatTime(sec) {
    const flooredSec = Math.floor(sec);

    const minutes = Math.floor(sec/60);
    const seconds = Math.floor(sec % 60);

    if(seconds < 10)
        return `${minutes}:0${seconds}`;
    else
        return `${minutes}:${seconds}`;

}

// Whole play bar HTML
playBar = html`
  <div class="playBar">
    <div class="songDetails">
      <img id="artwork" src="https://placehold.co/400?text=No+Art">
      <div id="textBox">
        <p id="song">Waiting for track...</p>
        <p id="artist">Waiting for artist...</p>
      </div>
    </div>

    <div class="mediaButtons">
      <button class="playButton" disabled>
        <i class="fa-solid fa-play"></i>
      </button>

      <div class="media-bar">
        <span class="song-time current-time">0:00</span>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
        <span class="song-time duration">0:00</span>
      </div>
    </div>

    <div class="settingsButtons"></div>
  </div>
`;

mediaButtonsEvents = {
    const playButton = playBar.querySelector(".playButton");
    const playIcon = playButton.querySelector("i");

    let playing = false;

    playButton.onclick = () => {
        playing = !playing;
        playing ? audioEl.play() : audioEl.pause();
        playIcon.className = playing
        ? "fa-solid fa-pause"
        : "fa-solid fa-play";
    };

    playBar;
}

timeUpdate = {
    audioEl.addEventListener("timeupdate", () => {
    playBar.querySelector(".current-time").textContent = formatTime(audioEl.currentTime);

    const progress =
        audioEl.currentTime / audioEl.duration || 0;

    playBar.querySelector(".progress-fill").style.width =
        `${progress * 100}%`;
    });

    return 0;
}

htmlUpdate = {
    // Don't update if audio isn't fully loaded
    if (!resultAPI) return;

    document.getElementById("upload-input").disabled = true;

    playBar.querySelector("#song").textContent = trackName;
    playBar.querySelector("#artist").textContent = artistName;
    playBar.querySelector("#artwork").src = imageURL;
    playBar.querySelector(".duration").textContent = formatTime(songDuration);

    playBar.querySelector(".playButton").disabled = false;

    return 0;
}

timeSelection = {
    const progressBar = playBar.querySelector(".progress-bar");

    progressBar.addEventListener("click", (e) => {
        const rect = progressBar.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;

        // Calculate new time
        const newTime = (clickX / width) * audioEl.duration;
        audioEl.currentTime = newTime;
    });

    return 0;
}

```